---
import BaseLayout from '../layouts/BaseLayout.astro';
import { getLangFromUrl } from '../i18n/utils';
import { getTranslations } from '../i18n/translations';

const lang = getLangFromUrl(Astro.url);
const t = getTranslations(lang);
---

<BaseLayout title={`${t.live.title} - ${t.site.name}`} description={t.live.title}>
  <div class="container mx-auto px-4 py-8 md:py-16">
    <h1 class="text-3xl md:text-4xl lg:text-5xl font-bold text-gray-900 mb-8 text-center">
      {t.live.title}
    </h1>

    <!-- Loading State -->
    <div id="loading-state" class="text-center py-12">
      <p class="text-gray-600">Cargando videos...</p>
    </div>

    <!-- Error State -->
    <div id="error-state" class="bg-yellow-50 border border-yellow-200 rounded-lg p-6 mb-8 hidden">
      <p class="text-yellow-800">
        <strong>Lo sentimos.</strong> No se pudieron obtener los videos recientes.
      </p>
    </div>

    <!-- Live Stream Section -->
    <section id="real-live-stream-section" class="mb-12 hidden">
      <div class="bg-red-600 text-white px-4 py-2 rounded-t-lg inline-block">
        <span class="flex items-center gap-2">
          <span class="w-3 h-3 bg-white rounded-full animate-pulse"></span>
          {t.live.liveNow}
        </span>
      </div>
      <div class="bg-gray-900 rounded-b-lg overflow-hidden">
        <div class="aspect-video">
          <iframe
            id="live-stream-iframe"
            title="Live Stream"
            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
            allowfullscreen
            class="w-full h-full"
          ></iframe>
        </div>
      </div>
      <div class="mt-4">
        <h2 id="live-stream-title" class="text-2xl font-semibold text-gray-900 mb-2"></h2>
      </div>
    </section>

    <!-- No Live Stream Message -->
    <div id="no-live-message" class="bg-blue-50 border border-blue-200 rounded-lg p-6 mb-8 text-center hidden">
      <p class="text-blue-800 text-lg">{t.live.noLive}</p>
    </div>

    <!-- Recent Videos Section -->
    <section id="recent-videos-section" class="hidden">
      <h2 class="text-2xl md:text-3xl font-bold text-gray-900 mb-6">
        {t.live.recentVideos}
      </h2>
      <div id="recent-videos-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
        <!-- Videos will be inserted here by JavaScript -->
      </div>
    </section>

    <!-- YouTube Data Fetcher and Demo Mode Handler -->
    <script>
      (function() {
        const urlParams = new URLSearchParams(window.location.search);
        const demoMode = urlParams.get('demo') === 'true';
        const realLiveStreamSection = document.getElementById('real-live-stream-section');
        const loadingState = document.getElementById('loading-state');
        const errorState = document.getElementById('error-state');
        const noLiveMessage = document.getElementById('no-live-message');
        const recentVideosSection = document.getElementById('recent-videos-section');
        const recentVideosGrid = document.getElementById('recent-videos-grid');

        // Fetch YouTube data from Edge Function
        async function fetchYouTubeData() {
          // In demo mode, we still want to show recent videos
          // Only skip showing the real live stream
          try {
            // Pass demo mode to Edge Function via query parameter
            const apiUrl = demoMode ? '/api/youtube-data?demo=true' : '/api/youtube-data';
            console.log('Fetching YouTube data from', apiUrl);
            const response = await fetch(apiUrl);
            console.log('Response status:', response.status);
            
            if (!response.ok) {
              const errorText = await response.text();
              console.error('Failed to fetch YouTube data:', response.status, errorText);
              throw new Error(`Failed to fetch YouTube data: ${response.status}`);
            }
            
            const data = await response.json();
            console.log('YouTube data received:', { 
              hasLiveStream: !!data.liveStream, 
              videoCount: data.recentVideos?.length || 0 
            });
            loadingState?.classList.add('hidden');

            if (data.liveStream) {
              const iframe = document.getElementById('live-stream-iframe') as HTMLIFrameElement;
              const title = document.getElementById('live-stream-title');
              if (iframe && title) {
                iframe.src = `https://www.youtube.com/embed/${data.liveStream.videoId}?autoplay=1&mute=1&playsinline=1`;
                iframe.title = data.liveStream.title;
                title.textContent = data.liveStream.title;
                realLiveStreamSection?.classList.remove('hidden');
              }
              noLiveMessage?.classList.add('hidden');
            } else {
              realLiveStreamSection?.classList.add('hidden');
              noLiveMessage?.classList.remove('hidden');
            }
            
            // Handle recent videos - always show if available, regardless of live stream status
            if (data.recentVideos && data.recentVideos.length > 0 && recentVideosGrid) {
              recentVideosGrid.innerHTML = '';
              data.recentVideos.forEach((video: any) => {
                const videoCard = document.createElement('a');
                videoCard.href = `https://www.youtube.com/watch?v=${video.videoId}`;
                videoCard.target = '_blank';
                videoCard.rel = 'noopener noreferrer';
                videoCard.className = 'group bg-white rounded-lg shadow-md border border-gray-200 overflow-hidden hover:shadow-lg transition-shadow';
                
                const formatDate = (dateString: string) => {
                  const date = new Date(dateString);
                  const now = new Date();
                  const diffInSeconds = Math.floor((now.getTime() - date.getTime()) / 1000);
                  
                  if (diffInSeconds < 60) return 'hace unos momentos';
                  if (diffInSeconds < 3600) {
                    const minutes = Math.floor(diffInSeconds / 60);
                    return `hace ${minutes} ${minutes === 1 ? 'minuto' : 'minutos'}`;
                  }
                  if (diffInSeconds < 86400) {
                    const hours = Math.floor(diffInSeconds / 3600);
                    return `hace ${hours} ${hours === 1 ? 'hora' : 'horas'}`;
                  }
                  if (diffInSeconds < 604800) {
                    const days = Math.floor(diffInSeconds / 86400);
                    return `hace ${days} ${days === 1 ? 'día' : 'días'}`;
                  }
                  return date.toLocaleDateString('es-ES', { year: 'numeric', month: 'long', day: 'numeric' });
                };
                
                videoCard.innerHTML = `
                  <div 
                    class="relative w-full bg-cover bg-center bg-gray-200 overflow-hidden"
                    style="padding-bottom: 56.25%; background-image: url('${video.thumbnail}');"
                    role="img"
                    aria-label="${video.title}"
                  >
                    <img
                      src="${video.thumbnail}"
                      alt=""
                      class="sr-only"
                      loading="lazy"
                    />
                    <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
                      <div class="absolute inset-0 bg-black opacity-0 group-hover:opacity-25 transition-opacity duration-300"></div>
                      <svg class="w-16 h-16 text-white opacity-0 group-hover:opacity-100 transition-opacity duration-300 relative z-10" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M8 5v14l11-7z"/>
                      </svg>
                    </div>
                  </div>
                  <div class="p-4">
                    <h3 class="font-semibold text-gray-900 mb-2 line-clamp-2 group-hover:text-blue-600 transition-colors">
                      ${video.title}
                    </h3>
                    <div class="text-sm text-gray-600">
                      <span>${formatDate(video.publishedAt)}</span>
                    </div>
                  </div>
                `;
                recentVideosGrid.appendChild(videoCard);
              });
              recentVideosSection?.classList.remove('hidden');
            }
          } catch (error) {
            console.error('Error fetching YouTube data:', error);
            loadingState?.classList.add('hidden');
            errorState?.classList.remove('hidden');
            
            // Show helpful error message
            const errorMsg = errorState?.querySelector('p');
            if (errorMsg && error instanceof Error) {
              errorMsg.innerHTML = `<strong>Error:</strong> ${error.message}<br><small>Make sure you're running <code>npm run dev:netlify</code> (not <code>npm run dev</code>) to enable Edge Functions locally.</small>`;
            }
          }
        }
        
        // Fetch data on page load
        fetchYouTubeData();
      })();
    </script>
  </div>
</BaseLayout>

